import argparse
import os
import base64
from github import Github
from github.GithubException import GithubException
import glob
from pathlib import Path

# Caminho para armazenar o token
TOKEN_PATH = os.path.expanduser("~/.mygit_token")

def get_github_client():
    """ObtÃ©m o cliente GitHub autenticado."""
    if not os.path.exists(TOKEN_PATH):
        print("âŒ Erro: VocÃª precisa fazer login primeiro!")
        print("ğŸ’¡ Execute: mygit login")
        print("   Depois digite seu token do GitHub quando solicitado.")
        exit(1)
    with open(TOKEN_PATH, 'r') as f:
        token = f.read().strip()
    return Github(token)

def login(args):
    """Faz login salvando o token do GitHub."""
    print("ğŸ”‘ Para fazer login, vocÃª precisa de um token do GitHub.")
    print("ğŸ“ Como obter um token:")
    print("   1. VÃ¡ para https://github.com/settings/tokens")
    print("   2. Clique em 'Generate new token (classic)'")
    print("   3. Selecione as permissÃµes necessÃ¡rias (repo, user)")
    print("   4. Copie o token gerado")
    print()
    
    token = input("Digite seu token do GitHub: ").strip()
    
    if not token:
        print("âŒ Erro: Token nÃ£o pode estar vazio!")
        print("ğŸ’¡ Execute novamente: mygit login")
        exit(1)
    
    try:
        g = Github(token)
        user = g.get_user()
        print(f"âœ… Login bem-sucedido como {user.login}")
        with open(TOKEN_PATH, 'w') as f:
            f.write(token)
    except GithubException as e:
        print(f"âŒ Erro ao fazer login: {e}")
        print("ğŸ’¡ Verifique se:")
        print("   - O token estÃ¡ correto")
        print("   - O token tem as permissÃµes necessÃ¡rias")
        print("   - Sua conexÃ£o com a internet estÃ¡ funcionando")
        exit(1)

def parse_repo_path(repo_path):
    """Interpreta o caminho do repositÃ³rio no formato usuario/repositÃ³rio:caminho."""
    if not repo_path:
        return None, None
    
    parts = repo_path.split(':', 1)
    repo_name = parts[0]
    repo_path = parts[1] if len(parts) > 1 else ""
    
    # Validar formato do repositÃ³rio
    if not repo_name or '/' not in repo_name:
        return None, None
    
    return repo_name, repo_path

def send_file(args):
    """Envia um arquivo local para o repositÃ³rio."""
    if not hasattr(args, 'file') or not args.file:
        print("âŒ Erro: Arquivo nÃ£o especificado!")
        print("ğŸ’¡ Uso correto: mygit send <arquivo_local> <usuario/repositorio[:caminho]>")
        print("ğŸ“ Exemplo: mygit send meuarquivo.txt usuario/meurepositorio:pasta/arquivo.txt")
        exit(1)
    
    if not hasattr(args, 'repo') or not args.repo:
        print("âŒ Erro: RepositÃ³rio nÃ£o especificado!")
        print("ğŸ’¡ Uso correto: mygit send <arquivo_local> <usuario/repositorio[:caminho]>")
        print("ğŸ“ Exemplo: mygit send meuarquivo.txt usuario/meurepositorio:pasta/arquivo.txt")
        exit(1)
    
    g = get_github_client()
    file_path, repo_path = args.file, args.repo
    repo_name, repo_file_path = parse_repo_path(repo_path)
    
    if not repo_name:
        print("âŒ Erro: Formato de repositÃ³rio invÃ¡lido!")
        print("ğŸ’¡ Formato esperado: usuario/repositorio[:caminho]")
        print("ğŸ“ Exemplos vÃ¡lidos:")
        print("   - usuario/meurepositorio")
        print("   - usuario/meurepositorio:arquivo.txt")
        print("   - usuario/meurepositorio:pasta/arquivo.txt")
        exit(1)
    
    try:
        repo = g.get_repo(repo_name)
    except GithubException as e:
        print(f"âŒ Erro: RepositÃ³rio '{repo_name}' nÃ£o encontrado ou inacessÃ­vel!")
        print("ğŸ’¡ Verifique se:")
        print("   - O nome do repositÃ³rio estÃ¡ correto")
        print("   - VocÃª tem permissÃ£o para acessar o repositÃ³rio")
        print("   - O repositÃ³rio existe")
        print(f"ğŸ“ Formato usado: {repo_name}")
        print(f"ğŸ” Erro tÃ©cnico: {e}")
        exit(1)
        
    if not os.path.isfile(file_path):
        print(f"âŒ Erro: '{file_path}' nÃ£o Ã© um arquivo vÃ¡lido!")
        print("ğŸ’¡ Verifique se:")
        print("   - O caminho do arquivo estÃ¡ correto")
        print("   - O arquivo existe")
        print("   - VocÃª tem permissÃ£o para ler o arquivo")
        print("ğŸ“ Caminho atual de trabalho:", os.getcwd())
        exit(1)
        
    try:
        with open(file_path, 'rb') as f:
            content = f.read()
        file_name = repo_file_path or os.path.basename(file_path)
        try:
            contents = repo.get_contents(file_name)
            repo.update_file(file_name, f"Update {file_name}", content, contents.sha)
            print(f"âœ… Arquivo {file_name} atualizado no repositÃ³rio {repo_name}")
        except GithubException as e:
            if e.status == 404:
                repo.create_file(file_name, f"Add {file_name}", content)
                print(f"âœ… Arquivo {file_name} enviado para o repositÃ³rio {repo_name}")
            else:
                print(f"âŒ Erro ao enviar arquivo: {e}")
                print("ğŸ’¡ PossÃ­veis causas:")
                print("   - Arquivo muito grande (limite do GitHub)")
                print("   - Sem permissÃ£o de escrita no repositÃ³rio")
                print("   - Conflito de nome de arquivo")
                exit(1)
    except Exception as e:
        print(f"âŒ Erro inesperado ao enviar arquivo: {e}")
        print("ğŸ’¡ Tente novamente ou verifique sua conexÃ£o.")
        exit(1)

def copy(args):
    """Copia arquivos de/para o repositÃ³rio."""
    if not hasattr(args, 'src') or not args.src:
        print("âŒ Erro: Origem nÃ£o especificada!")
        print("ğŸ’¡ Uso correto: mygit copy <origem> <destino>")
        print("ğŸ“ Exemplos:")
        print("   Upload: mygit copy ./pasta usuario/repo:pasta_remota")
        print("   Download: mygit copy usuario/repo:arquivo.txt ./local/")
        exit(1)
    
    if not hasattr(args, 'dst') or not args.dst:
        print("âŒ Erro: Destino nÃ£o especificado!")
        print("ğŸ’¡ Uso correto: mygit copy <origem> <destino>")
        print("ğŸ“ Exemplos:")
        print("   Upload: mygit copy ./pasta usuario/repo:pasta_remota")
        print("   Download: mygit copy usuario/repo:arquivo.txt ./local/")
        exit(1)
    
    g = get_github_client()
    src, dst = args.src, args.dst
    
    if src.startswith('.') or not ':' in src:
        # Upload: local -> remoto
        repo_name, repo_path = parse_repo_path(dst)
        
        if not repo_name:
            print("âŒ Erro: Formato de repositÃ³rio de destino invÃ¡lido!")
            print("ğŸ’¡ Para upload, o destino deve ser: usuario/repositorio[:caminho]")
            print("ğŸ“ Exemplo: mygit copy ./meuarquivo.txt usuario/meurepositorio:pasta/")
            exit(1)
        
        try:
            repo = g.get_repo(repo_name)
        except GithubException as e:
            print(f"âŒ Erro: RepositÃ³rio '{repo_name}' nÃ£o encontrado ou inacessÃ­vel!")
            print("ğŸ’¡ Verifique se:")
            print("   - O nome do repositÃ³rio estÃ¡ correto")
            print("   - VocÃª tem permissÃ£o para acessar o repositÃ³rio")
            print(f"ğŸ” Erro tÃ©cnico: {e}")
            exit(1)
            
        src_path = Path(src)
        if not src_path.exists():
            print(f"âŒ Erro: '{src}' nÃ£o existe!")
            print("ğŸ’¡ Verifique o caminho do arquivo ou pasta.")
            print("ğŸ“ Caminho atual de trabalho:", os.getcwd())
            exit(1)
            
        if src_path.is_dir():
            print(f"ğŸ“ Enviando pasta '{src}' para '{repo_name}'...")
            for file_path in src_path.rglob('*'):
                if file_path.is_file():
                    rel_path = file_path.relative_to(src_path)
                    dest_path = os.path.join(repo_path, str(rel_path)).replace('\\', '/')
                    with open(file_path, 'rb') as f:
                        content = f.read()
                    try:
                        contents = repo.get_contents(dest_path)
                        repo.update_file(dest_path, f"Update {dest_path}", content, contents.sha)
                        print(f"âœ… Arquivo {dest_path} atualizado em {repo_name}")
                    except GithubException as e:
                        if e.status == 404:
                            repo.create_file(dest_path, f"Add {dest_path}", content)
                            print(f"âœ… Arquivo {dest_path} enviado para {repo_name}")
                        else:
                            print(f"âŒ Erro ao enviar arquivo {dest_path}: {e}")
                            exit(1)
        elif src_path.is_file():
            dest_path = repo_path or os.path.basename(src)
            with open(src, 'rb') as f:
                content = f.read()
            try:
                contents = repo.get_contents(dest_path)
                repo.update_file(dest_path, f"Update {dest_path}", content, contents.sha)
                print(f"âœ… Arquivo {dest_path} atualizado em {repo_name}")
            except GithubException as e:
                if e.status == 404:
                    repo.create_file(dest_path, f"Add {dest_path}", content)
                    print(f"âœ… Arquivo {dest_path} enviado para {repo_name}")
                else:
                    print(f"âŒ Erro ao enviar arquivo {dest_path}: {e}")
                    exit(1)
        else:
            print(f"âŒ Erro: {src} nÃ£o Ã© um arquivo ou diretÃ³rio vÃ¡lido.")
            exit(1)
    else:
        # Download: remoto -> local
        repo_name, repo_path = parse_repo_path(src)
        
        if not repo_name:
            print("âŒ Erro: Formato de repositÃ³rio de origem invÃ¡lido!")
            print("ğŸ’¡ Para download, a origem deve ser: usuario/repositorio:caminho")
            print("ğŸ“ Exemplo: mygit copy usuario/meurepositorio:arquivo.txt ./local/")
            exit(1)
        
        try:
            repo = g.get_repo(repo_name)
        except GithubException as e:
            print(f"âŒ Erro: RepositÃ³rio '{repo_name}' nÃ£o encontrado ou inacessÃ­vel!")
            print("ğŸ’¡ Verifique se:")
            print("   - O nome do repositÃ³rio estÃ¡ correto")
            print("   - VocÃª tem permissÃ£o para acessar o repositÃ³rio")
            print(f"ğŸ” Erro tÃ©cnico: {e}")
            exit(1)
        try:
            contents = repo.get_contents(repo_path)
            if isinstance(contents, list):
                os.makedirs(dst, exist_ok=True)
                print(f"ğŸ“ Baixando pasta '{repo_path}' para '{dst}'...")
                for content in contents:
                    if content.type == 'file':
                        file_content = base64.b64decode(content.content)
                        local_path = os.path.join(dst, content.name)
                        with open(local_path, 'wb') as f:
                            f.write(file_content)
                        print(f"âœ… Arquivo {content.name} baixado para {local_path}")
            else:
                file_content = base64.b64decode(contents.content)
                local_path = os.path.join(dst, contents.name)
                os.makedirs(os.path.dirname(local_path), exist_ok=True)
                with open(local_path, 'wb') as f:
                    f.write(file_content)
                print(f"âœ… Arquivo {contents.name} baixado para {local_path}")
        except GithubException as e:
            print(f"âŒ Erro ao baixar de '{repo_path}': {e}")
            print("ğŸ’¡ Verifique se:")
            print("   - O caminho do arquivo/pasta estÃ¡ correto")
            print("   - O arquivo/pasta existe no repositÃ³rio")
            print("   - VocÃª tem permissÃ£o para acessar o conteÃºdo")
            exit(1)

def remove_file(args):
    """Remove um arquivo do repositÃ³rio."""
    if not hasattr(args, 'file') or not args.file:
        print("âŒ Erro: Arquivo nÃ£o especificado!")
        print("ğŸ’¡ Uso correto: mygit rm <usuario/repositorio:caminho>")
        print("ğŸ“ Exemplo: mygit rm usuario/meurepositorio:arquivo.txt")
        exit(1)
    
    g = get_github_client()
    repo_name, repo_path = parse_repo_path(args.file)
    
    if not repo_name:
        print("âŒ Erro: Formato de repositÃ³rio invÃ¡lido!")
        print("ğŸ’¡ Formato esperado: usuario/repositorio:caminho")
        print("ğŸ“ Exemplo: mygit rm usuario/meurepositorio:arquivo.txt")
        exit(1)
    
    if not repo_path:
        print("âŒ Erro: Caminho do arquivo nÃ£o especificado!")
        print("ğŸ’¡ VocÃª deve especificar qual arquivo remover.")
        print("ğŸ“ Exemplo: mygit rm usuario/meurepositorio:arquivo.txt")
        exit(1)
    
    try:
        repo = g.get_repo(repo_name)
        contents = repo.get_contents(repo_path)
        
        # Check if contents is a list (directory) or a single ContentFile (file)
        if isinstance(contents, list):
            print(f"âŒ Erro: '{repo_path}' Ã© um diretÃ³rio, nÃ£o um arquivo!")
            print("ğŸ’¡ VocÃª deve especificar um arquivo especÃ­fico para remover.")
            print("ğŸ“ Exemplo: mygit rm usuario/meurepositorio:arquivo.txt")
            exit(1)
        
        # If it's a single file, proceed with deletion
        repo.delete_file(repo_path, f"Remove {repo_path}", contents.sha)
        print(f"âœ… Arquivo {repo_path} removido de {repo_name}")
    except GithubException as e:
        if e.status == 404:
            print(f"âŒ Erro: Arquivo '{repo_path}' nÃ£o encontrado no repositÃ³rio '{repo_name}'!")
            print("ğŸ’¡ Verifique se:")
            print("   - O caminho do arquivo estÃ¡ correto")
            print("   - O arquivo realmente existe no repositÃ³rio")
        else:
            print(f"âŒ Erro ao remover arquivo: {e}")
            print("ğŸ’¡ Verifique se:")
            print("   - VocÃª tem permissÃ£o para remover arquivos")
            print("   - O repositÃ³rio existe e estÃ¡ acessÃ­vel")
        exit(1)

def list_files(args):
    """Lista arquivos no repositÃ³rio ou repositÃ³rios do usuÃ¡rio."""
    g = get_github_client()
    
    repo_arg = args.repo if hasattr(args, 'repo') and args.repo else ":."
    
    if repo_arg == ':.':
        # Lista todos os repositÃ³rios do usuÃ¡rio autenticado
        try:
            user = g.get_user()
            repos = user.get_repos()
            if not repos.totalCount:
                print("ğŸ“‚ Nenhum repositÃ³rio encontrado para o usuÃ¡rio.")
                return
            print(f"ğŸ“‚ RepositÃ³rios do usuÃ¡rio {user.login}:")
            for repo in repos:
                print(f"   repo: {repo.full_name}")
        except GithubException as e:
            print(f"âŒ Erro ao listar repositÃ³rios: {e}")
            print("ğŸ’¡ Verifique sua conexÃ£o e permissÃµes.")
            exit(1)
    else:
        # Lista arquivos no repositÃ³rio especificado
        repo_name, repo_path = parse_repo_path(repo_arg)
        
        if not repo_name:
            print("âŒ Erro: Formato de repositÃ³rio invÃ¡lido!")
            print("ğŸ’¡ Formatos vÃ¡lidos:")
            print("   - mygit ls :. (lista seus repositÃ³rios)")
            print("   - mygit ls usuario/repositorio (lista raiz do repositÃ³rio)")
            print("   - mygit ls usuario/repositorio:pasta (lista pasta especÃ­fica)")
            exit(1)
        
        try:
            repo = g.get_repo(repo_name)
            contents = repo.get_contents(repo_path)
            print(f"ğŸ“‚ ConteÃºdo de '{repo_name}:{repo_path or '/'}':")
            if isinstance(contents, list):
                for content in contents:
                    icon = "ğŸ“" if content.type == 'dir' else "ğŸ“„"
                    print(f"   {icon} {content.type}: {content.path}")
            else:
                icon = "ğŸ“" if contents.type == 'dir' else "ğŸ“„"
                print(f"   {icon} {contents.type}: {contents.path}")
        except GithubException as e:
            if e.status == 404:
                print(f"âŒ Erro: RepositÃ³rio '{repo_name}' ou caminho '{repo_path}' nÃ£o encontrado!")
                print("ğŸ’¡ Verifique se:")
                print("   - O nome do repositÃ³rio estÃ¡ correto")
                print("   - O caminho existe no repositÃ³rio")
                print("   - VocÃª tem permissÃ£o para acessar o repositÃ³rio")
            else:
                print(f"âŒ Erro ao listar arquivos: {e}")
                print("ğŸ’¡ Verifique sua conexÃ£o e permissÃµes.")
            exit(1)

def main():
    parser = argparse.ArgumentParser(
        description="ğŸ™ CLI para gerenciar repositÃ³rios GitHub de forma simples",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Exemplos de uso:
  mygit login                                    # Fazer login no GitHub
  mygit ls :.                                    # Listar seus repositÃ³rios
  mygit ls usuario/repo                          # Listar arquivos na raiz do repositÃ³rio
  mygit ls usuario/repo:pasta                    # Listar arquivos em uma pasta
  mygit send arquivo.txt usuario/repo            # Enviar arquivo para a raiz
  mygit send arquivo.txt usuario/repo:pasta/     # Enviar arquivo para uma pasta
  mygit copy ./pasta usuario/repo:pasta_remota   # Enviar pasta completa
  mygit copy usuario/repo:arquivo.txt ./local/   # Baixar arquivo
  mygit rm usuario/repo:arquivo.txt              # Remover arquivo

Formato de repositÃ³rio: usuario/repositorio[:caminho]
        """
    )
    subparsers = parser.add_subparsers(dest="command", help="Comandos disponÃ­veis")

    # Login
    login_parser = subparsers.add_parser("login", help="Faz login no GitHub")
    login_parser.set_defaults(func=login)

    # Send
    send_parser = subparsers.add_parser("send", help="Envia um arquivo para o repositÃ³rio")
    send_parser.add_argument("file", help="Caminho do arquivo local")
    send_parser.add_argument("repo", help="RepositÃ³rio no formato usuario/repositorio[:caminho]")
    send_parser.set_defaults(func=send_file)

    # Copy
    copy_parser = subparsers.add_parser("copy", help="Copia arquivos de/para o repositÃ³rio")
    copy_parser.add_argument("src", help="Origem (local ou usuario/repositorio:caminho)")
    copy_parser.add_argument("dst", help="Destino (local ou usuario/repositorio:caminho)")
    copy_parser.set_defaults(func=copy)

    # Remove
    rm_parser = subparsers.add_parser("rm", help="Remove um arquivo do repositÃ³rio")
    rm_parser.add_argument("file", help="Arquivo no formato usuario/repositorio:caminho")
    rm_parser.set_defaults(func=remove_file)

    # List
    ls_parser = subparsers.add_parser("ls", help="Lista arquivos no repositÃ³rio")
    ls_parser.add_argument("repo", help="RepositÃ³rio no formato usuario/repositorio[:caminho]", nargs="?", default=":.")
    ls_parser.set_defaults(func=list_files)

    args = parser.parse_args()

    if hasattr(args, 'func'):
        args.func(args)
    else:
        print("âŒ Nenhum comando especificado!")
        print("ğŸ’¡ Comandos disponÃ­veis: login, send, copy, rm, ls")
        print("ğŸ“ Use 'mygit --help' para ver todos os comandos e exemplos.")
        parser.print_help()

if __name__ == "__main__":
    main()
